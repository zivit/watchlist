import { VerticalBox, HorizontalBox } from "std-widgets.slint";
import { ToolBar, ToolButton } from "ToolBar.slint";
import { Show, Status } from "Structs.slint";
import { Images, Palette } from "Global.slint";
import { TextEdit } from "TextEdit.slint";
import { LineEdit } from "LineEdit.slint";
import { ListElement, ListElementCompact } from "ListElement.slint";

export component Watchlist inherits Rectangle {
    in-out property <[Show]> shows;
    out property <bool> mode-compact: false;
    callback add-clicked();
    callback show-clicked(Show);
    callback search(string);
    callback search-cancel();

    in-out property <bool> search-mode: false;

    VerticalBox {
        padding: 0px;
        spacing: 0px;

        ToolBar {
            height: 50px;
            background: Palette.primary;

            if !search-mode : HorizontalBox {
                padding: 0px;
                spacing: 0px;
                width: parent.width;
                height: parent.height;
                alignment: space-between;

                mode-button := ToolButton {
                    hint: "Change view mode";
                    icon: mode-compact ? Images.list-compact : Images.list;
                    width: 50px;
                    height: 50px;
                    background-color: Palette.primary;

                    clicked => {
                        mode-compact = !mode-compact;
                    }
                }

                search-button := ToolButton {
                    hint: "Search";
                    hint-direction-left: true;
                    icon: Images.search;
                    width: 50px;
                    height: 50px;
                    background-color: Palette.primary;

                    clicked => {
                        search-mode = true;
                    }
                }
            }

            if search-mode : HorizontalBox {
                padding: 0px;
                spacing: 0px;
                width: parent.width;
                height: parent.height;
                alignment: stretch;

                search-input := LineEdit {
                    placeholder-text: "Enter the show name here";
                    border-width: 0px;

                    edited => {
                        search(self.text);
                    }
                }

                cancel-button := ToolButton {
                    hint: "Cancel";
                    hint-direction-left: true;
                    icon: Images.cancel;
                    width: 50px;
                    height: 50px;
                    background-color: Palette.primary;

                    clicked => {
                        search-mode = false;
                        search-cancel();
                    }
                }
            }
        }

        if !root.mode-compact : HorizontalLayout {
            property <float> scroll-coef: list.height / list.viewport-height;

            list := Flickable {
                VerticalBox {
                    padding: 0px;
                    spacing: 0px;

                    for s in shows : ListElement {
                        show: s;
                        title-color: s.new-episodes-available && s.status == Status.watching ?
                            Palette.light-blue : Palette.text;

                        Rectangle {
                            background: #101010;
                            height: 1px;
                            y: parent.height - 1px;
                        }

                        TouchArea {
                            clicked() => {
                                show-clicked(s);
                            }
                        }
                    }
                }
            }

            scrollbar := Rectangle {
                width: 8px;
                background: Palette.primary;

                scrollbar-indicator := Rectangle {
                    height: min(list.height, scroll-coef * list.height);
                    y: -list.viewport-y * scroll-coef;
                    background: Palette.border;
                }
            }
        }
        if root.mode-compact : HorizontalLayout {
            property <float> scroll-coef: list-compact.height / list-compact.viewport-height;

            list-compact := Flickable {
                VerticalBox {
                    padding: 0px;
                    spacing: 0px;

                    for s in shows : ListElementCompact {
                        show: s;
                        title-color: s.new-episodes-available && s.status == Status.watching ?
                            Palette.light-blue : Palette.text;

                        Rectangle {
                            background: #101010;
                            height: 1px;
                            y: parent.height - 1px;
                        }

                        TouchArea {
                            clicked() => {
                                show-clicked(s);
                            }
                        }
                    }
                }
            }

            scrollbar-compact := Rectangle {
                width: 8px;
                background: Palette.primary;

                scrollbar-indicator-compact := Rectangle {
                    height: min(list-compact.height, scroll-coef * list-compact.height);
                    y: -list-compact.viewport-y * scroll-coef;
                    background: Palette.border;
                }
            }
        }
    }

    add-button := ToolButton {
        icon: Images.add;
        x: root.width - 80px;
        y: root.height - 80px;
        width: 50px;
        height: 50px;
        background-color: #e36307;
        border-radius: self.width / 2;
        drop-shadow-color: #101010;
        drop-shadow-offset-y: 1px;
        drop-shadow-blur: 4px;
        z: 10;

        clicked => {
            add-clicked();
        }
    }
}
